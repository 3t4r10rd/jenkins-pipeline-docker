//$srv_nex - docker registry sererer:port, $tag - tag dockeragent image
pipeline {
    agent {
        docker {
            image 'dockeragent:$tag'
            registryUrl 'http://$srv_nex'
            registryCredentialsId '0956746a-1ee8-43f5-9651-cf7aada4b50f'
            args '-u root --privileged -v /var/run/docker.sock:/var/run/docker.sock'
        }
    }
    
    stages {
        
        stage ('Copy sources from github and remote machine') {
            steps {
                git 'https://github.com/3t4r10rd/boxfuse5.git'
                //sh 'ssh-keyscan -H 34.118.71.129 >> /root/.ssh/known_hosts'
                //sshagent(['0b09ca00-b982-4731-b7c0-dc71fac8eb25']) {
                //sh 'scp root@34.118.71.129:/home/docker /home/docker'
                //}
            }
        }
        
        stage ('build war') {
            steps {
                sh 'mvn package'
            }
        }
        
        stage ('Make docker iamge') {
            steps {
                //sh 'mkdir /home/docker'
                sh 'cp $(find -name "*.war") /home/docker'
                //sh 'echo $(ls /home/docker/)'
                sh 'docker build -t maventomcat /home/docker/'
                sh 'docker tag maventomcat $srv_nex/maventomcat:1'
                sh 'rm -rf /etc/docker/daemon.json  && echo "{ \"insecure-registries\" : [\"$srv_nex\"] }" >> /etc/docker/daemon.json'
                //sh 'service docker restart'
                sh 'docker push $srv_nex/maventomcat:1'
            }
        } 
    }
    
}
